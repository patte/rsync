services:
  rsync:
    build:
      context: ..
      dockerfile: Dockerfile
    image: rsync:test
    cap_drop: ["ALL"]
    cap_add:
      - CHOWN
      - FOWNER
      - SETUID
      - SETGID
      - SYS_CHROOT
    environment:
      - FS_UID=1234
      - FS_GID=1234
    ports:
      - "2122:22"
    volumes:
      - ./tmp/data:/data
      - ./tmp/keys/host:/var/rsync/host
      - ./tmp/keys/clients:/var/rsync/clients:ro
    healthcheck:
      test: ["CMD-SHELL", "pgrep -x sshd >/dev/null"]
      interval: 3s
      timeout: 2s
      retries: 60
